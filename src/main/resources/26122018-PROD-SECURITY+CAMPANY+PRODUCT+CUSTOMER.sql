use directs;

SET FOREIGN_KEY_CHECKS=0; 
DROP TABLE IF EXISTS `AUTHORITY`;

CREATE TABLE `authority` (
  `ID` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
  `NAME` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`ID`),
  UNIQUE KEY `UK_UNIQUE_NAME` (`NAME`)
) ENGINE = InnoDB DEFAULT CHARACTER SET = utf8;


DROP TABLE IF EXISTS `USER`;

CREATE TABLE `user` (
  `ID` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
  `PASSWORD` varchar(255) DEFAULT NULL,
  `USER_NAME` varchar(255) DEFAULT NULL,
  `ACCOUNT_EXPIRED` BOOLEAN,
  `ACCOUNT_LOCKED` BOOLEAN,
  `CREDENTIALS_EXPIRED` BOOLEAN,
  `ENABLED` BOOLEAN,
  PRIMARY KEY (`ID`),
  UNIQUE KEY `UK_UNIQUE_USER_NAME` (`USER_NAME`)
) ENGINE = InnoDB DEFAULT CHARACTER SET = utf8;

DROP TABLE IF EXISTS `USERS_AUTHORITIES`;

CREATE TABLE `users_authorities` (
  `USER_ID` INT(10) UNSIGNED NOT NULL,
  `AUTHORITY_ID` INT(10) UNSIGNED NOT NULL,
  CONSTRAINT `USERS_AUTHORITIES_AUTHORITY`
    FOREIGN KEY (`AUTHORITY_ID`)
    REFERENCES `directs`.`AUTHORITY` (`ID`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `USERS_AUTHORITIES_USER`
    FOREIGN KEY (`USER_ID`)
    REFERENCES `directs`.`USER` (`ID`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION
) ENGINE = InnoDB DEFAULT CHARACTER SET = utf8;

DROP TABLE IF EXISTS `OAUTH_CLIENT_DETAILS`;

CREATE TABLE oauth_client_details (
  CLIENT_ID VARCHAR(255) PRIMARY KEY,
  RESOURCE_IDS VARCHAR(255),
  CLIENT_SECRET VARCHAR(255),
  SCOPE VARCHAR(255),
  AUTHORIZED_GRANT_TYPES VARCHAR(255),
  WEB_SERVER_REDIRECT_URI VARCHAR(255),
  AUTHORITIES VARCHAR(255),
  ACCESS_TOKEN_VALIDITY INTEGER,
  REFRESH_TOKEN_VALIDITY INTEGER,
  ADDITIONAL_INFORMATION VARCHAR(4096),
  AUTOAPPROVE VARCHAR(255)
);

DROP TABLE IF EXISTS `OAUTH_CLIENT_TOKEN`;

CREATE TABLE oauth_client_token (
  TOKEN_ID VARCHAR(255),
  TOKEN BLOB,
  AUTHENTICATION_ID VARCHAR(255) PRIMARY KEY,
  USER_NAME VARCHAR(255),
  CLIENT_ID VARCHAR(255)
);

DROP TABLE IF EXISTS `OAUTH_ACCESS_TOKEN`;

CREATE TABLE oauth_access_token (
  TOKEN_ID VARCHAR(255),
  TOKEN BLOB,
  AUTHENTICATION_ID VARCHAR(255) PRIMARY KEY,
  USER_NAME VARCHAR(255),
  CLIENT_ID VARCHAR(255),
  AUTHENTICATION BLOB,
  REFRESH_TOKEN VARCHAR(255)
);

DROP TABLE IF EXISTS `OAUTH_REFRESH_TOKEN`;

CREATE TABLE oauth_refresh_token (
  TOKEN_ID VARCHAR(255),
  TOKEN BLOB,
  AUTHENTICATION BLOB
);

DROP TABLE IF EXISTS `OAUTH_CODE`;

CREATE TABLE oauth_code (
  CODE VARCHAR(255),
  AUTHENTICATION BLOB
);


DROP TABLE IF EXISTS `OAUTH_APPROVALS`;

CREATE TABLE oauth_approvals (
  USERID VARCHAR(255),
  CLIENTID VARCHAR(255),
  SCOPE VARCHAR(255),
  STATUS VARCHAR(10),
  EXPIRESAT TIMESTAMP,
  LASTMODIFIEDAT TIMESTAMP
);


INSERT INTO oauth_client_details(CLIENT_ID, RESOURCE_IDS, CLIENT_SECRET, SCOPE, AUTHORIZED_GRANT_TYPES, AUTHORITIES, ACCESS_TOKEN_VALIDITY, REFRESH_TOKEN_VALIDITY)
	VALUES ('spring-security-oauth2-read-client', 'resource-server-rest-api',
	/*spring-security-oauth2-read-client-password1234*/'$2a$04$WGq2P9egiOYoOFemBRfsiO9qTcyJtNRnPKNBl5tokP7IP.eZn93km',
	'read', 'password,authorization_code,refresh_token,implicit', 'USER', 10800, 2592000);
    
INSERT INTO oauth_client_details(CLIENT_ID, RESOURCE_IDS, CLIENT_SECRET, SCOPE, AUTHORIZED_GRANT_TYPES, AUTHORITIES, ACCESS_TOKEN_VALIDITY, REFRESH_TOKEN_VALIDITY)
	VALUES ('spring-security-oauth2-read-write-client', 'resource-server-rest-api',
	/*spring-security-oauth2-read-write-client-password1234*/'$2a$04$soeOR.QFmClXeFIrhJVLWOQxfHjsJLSpWrU1iGxcMGdu.a5hvfY4W',
	'read,write', 'password,authorization_code,refresh_token,implicit', 'USER', 10800, 2592000);
    

INSERT INTO authority(ID, NAME) VALUES (1, 'COMPANY_CREATE');
INSERT INTO authority(ID, NAME) VALUES (2, 'COMPANY_READ');
INSERT INTO authority(ID, NAME) VALUES (3, 'COMPANY_UPDATE');
INSERT INTO authority(ID, NAME) VALUES (4, 'COMPANY_DELETE');

INSERT INTO authority(ID, NAME) VALUES (5, 'CUSTOMER_CREATE');
INSERT INTO authority(ID, NAME) VALUES (6, 'CUSTOMER_READ');
INSERT INTO authority(ID, NAME) VALUES (7, 'CUSTOMER_UPDATE');
INSERT INTO authority(ID, NAME) VALUES (8, 'CUSTOMER_DELETE');

INSERT INTO authority(ID, NAME) VALUES (9, 'ROLE_COMPANY_READER');
INSERT INTO authority(ID, NAME) VALUES (10, 'ROLE_ADMIN');



-- Isertion users

INSERT INTO `user`(ID, USER_NAME, PASSWORD, ACCOUNT_EXPIRED, ACCOUNT_LOCKED, CREDENTIALS_EXPIRED, ENABLED)
  VALUES (1, 'admin', /*admin1234*/'$2a$08$qvrzQZ7jJ7oy2p/msL4M0.l83Cd0jNsX6AJUitbgRXGzge4j035ha', FALSE, FALSE, FALSE, TRUE);

INSERT INTO `user`(ID, USER_NAME, PASSWORD, ACCOUNT_EXPIRED, ACCOUNT_LOCKED, CREDENTIALS_EXPIRED, ENABLED)
  VALUES (2, 'reader', /*reader1234*/'$2a$08$dwYz8O.qtUXboGosJFsS4u19LHKW7aCQ0LXXuNlRfjjGKwj5NfKSe', FALSE, FALSE, FALSE, TRUE);

INSERT INTO `user`(ID, USER_NAME, PASSWORD, ACCOUNT_EXPIRED, ACCOUNT_LOCKED, CREDENTIALS_EXPIRED, ENABLED)
  VALUES (3, 'modifier', /*modifier1234*/'$2a$08$kPjzxewXRGNRiIuL4FtQH.mhMn7ZAFBYKB3ROz.J24IX8vDAcThsG', FALSE, FALSE, FALSE, TRUE);

INSERT INTO `user`(ID, USER_NAME, PASSWORD, ACCOUNT_EXPIRED, ACCOUNT_LOCKED, CREDENTIALS_EXPIRED, ENABLED)
  VALUES (4, 'reader2', /*reader1234*/'$2a$08$vVXqh6S8TqfHMs1SlNTu/.J25iUCrpGBpyGExA.9yI.IlDRadR6Ea', FALSE, FALSE, FALSE, TRUE);


INSERT INTO users_authorities(USER_ID, AUTHORITY_ID) VALUES (1, 9);
INSERT INTO users_authorities(USER_ID, AUTHORITY_ID) VALUES (1, 10);

INSERT INTO users_authorities(USER_ID, AUTHORITY_ID) VALUES (2, 2);
INSERT INTO users_authorities(USER_ID, AUTHORITY_ID) VALUES (2, 6);

INSERT INTO users_authorities(USER_ID, AUTHORITY_ID) VALUES (3, 3);
INSERT INTO users_authorities(USER_ID, AUTHORITY_ID) VALUES (3, 7);

INSERT INTO users_authorities(USER_ID, AUTHORITY_ID) VALUES (4, 9);

DROP TABLE IF EXISTS `company`;

CREATE TABLE `company` (
  `cmp_id` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
  `cmp_created_date` DATETIME NULL DEFAULT CURRENT_TIMESTAMP,
  `cmp_uid` varchar(64) NOT NULL,
  `cmp_additional_address` varchar(255) DEFAULT NULL,
  `cmp_address` varchar(255) DEFAULT NULL,
  `cmp_city` varchar(255) DEFAULT NULL,
  `cmp_fax_number` varchar(30) DEFAULT NULL,
  `cmp_mail` varchar(255) DEFAULT NULL,
  `cmp_name` varchar(255) NOT NULL,
  `cmp_phone_number` varchar(30) DEFAULT NULL,
  `cmp_tva_number` varchar(50) NOT NULL,
  `cmp_zipe_code` varchar(10) DEFAULT NULL,
  PRIMARY KEY (`cmp_id`),
  INDEX  (`cmp_name`),
  UNIQUE KEY `UK_UID_company` (`cmp_uid`)
) ENGINE = InnoDB DEFAULT CHARACTER SET = utf8;

INSERT INTO `directs`.`company` (`cmp_id`, `cmp_created_date`, `cmp_uid`, `cmp_additional_address`, `cmp_address`, `cmp_city`, `cmp_fax_number`, `cmp_mail`, `cmp_name`, `cmp_phone_number`, `cmp_tva_number`, `cmp_zipe_code`) VALUES ('1', '2018-12-04 16:05:23', '00000000-ae4e-40f7-9f62-410d811984dd', 'D1', '1 Rue de Paris', 'PARIS', '0102030406', 'direct@gmail.com', 'DIRECT PLAST', '0601020304', 'TN12345678', '75001');

ALTER TABLE `user`
	ADD `COMPANY_ID` INT(10) UNSIGNED NOT NULL;


ALTER TABLE `product`
	ADD `pr_company_id` INT(10) UNSIGNED DEFAULT NULL,
    ADD CONSTRAINT `fk_company_products`
	FOREIGN KEY(`pr_company_id`) REFERENCES `directs`.`company`(`cmp_id`)
    ON DELETE NO ACTION ON UPDATE NO ACTION;
    
UPDATE `directs`.`product` SET `pr_company_id` = '1' WHERE (`pr_id` = '1');


ALTER TABLE `customer`
	ADD `cus_company_id` INT(10) UNSIGNED DEFAULT NULL,
    ADD CONSTRAINT `fk_company_customers`
	FOREIGN KEY(`cus_company_id`) REFERENCES `directs`.`company`(`cmp_id`)
    ON DELETE NO ACTION ON UPDATE NO ACTION;
    
UPDATE `directs`.`customer` SET `cus_company_id` = '1' WHERE (`cus_id` = '1');
UPDATE `directs`.`customer` SET `cus_company_id` = '1' WHERE (`cus_id` = '2');

